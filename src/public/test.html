<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACG-COM</title>
    <link rel="stylesheet" href="assets/css/output.css">
    <link rel="shortcut icon" href="assets/images/newlogo.png" type="image/x-icon">
</head>

<body class="text-white bg-fixed bg-center bg-cover dark:bg-black font-verdana"
    style="background-image: url('assets/images/newass.jpg');">
    <section class="max-w-[500px] block  min-w-[400px] md:w-full md:max-w-full md:min-w-full">
        <div class="w-full sticky top-0 flex bg-neutral-10 justify-between p-1 z-50 bg-white">
            <img src="assets/images/newlogo.png" class="w-12" alt="">
            <div class="flex items-center">
                <div class="border flex items-center px-2 rounded-lg">
                    <input type="search" placeholder="search here..."
                        class="bg-transparent h-10 placeholder:text-semibold font-italic font-verdana">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
                </svg>

            </div>
        </div>



        <main class="w-full h-screen bg-center bg-no-repeat bg-fixed pt-10"
            style="background-image: url('assets/images/newass.jpg');">
            <section class="w-full p-2 mt-10">
                <div class="m-auto flex justify-center mt-10">
                    <p id="waiting_Connexion"
                        class="flex gap-2 text-2xl font-semibold text-neutral-100 items-center bg-gray-500 p-1 rounded-lg">
                        Server Connexion ...
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-6 h-6 animate-spin">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                    </p>
                </div>
            </section>
            <section id="videocontainerFixed" class="flex flex-wrap justify-around p-2 gap-5">


                <div class="border rounded-lg w-full p-5 bg-white text-center mt-4 flex items-center text-black">
                    <p>My Mic</p>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                        class="w-10 h-10 m-auto">
                        <path d="M8.25 4.5a3.75 3.75 0 117.5 0v8.25a3.75 3.75 0 11-7.5 0V4.5z" />
                        <path
                            d="M6 10.5a.75.75 0 01.75.75v1.5a5.25 5.25 0 1010.5 0v-1.5a.75.75 0 011.5 0v1.5a6.751 6.751 0 01-6 6.709v2.291h3a.75.75 0 010 1.5h-7.5a.75.75 0 010-1.5h3v-2.291a6.751 6.751 0 01-6-6.709v-1.5A.75.75 0 016 10.5z" />
                    </svg>

                </div>
            </section>
        </main>
    </section>


    <!-- Scripts déplacés ici pour améliorer les performances -->
    <script src="assets/js/jquery.js"></script>
    <script src="socket.io/socket.io.js"></script>
    <script src="assets/js/peer.js"></script>



    <script>
        const socket = io();
        let peer = null;
        const peers = {}; // Stocker les pairs pour chaque utilisateur connecté
        var i = 0;
        socket.on('connectedToServer', (data) => {
            $("#waiting_Connexion").hide();
        });

        socket.on('user-connected', (userId) => {
            console.log(`Nouvel utilisateur connecté : ${userId}`);
            // Créer un peer pour le nouvel utilisateur
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then((stream) => {
                    const newPeer = createPeer(true, stream, userId);
                    peers[userId] = newPeer;
                    displayLocalStream(stream);
                })
                .catch((err) => {
                    console.error('Erreur accès caméra/micro:', err);
                });
        });

        socket.on('offer', (data) => {
            const { userId, offer } = JSON.parse(data);
            acceptCall(userId, offer);
        });

        socket.on('answer', (data) => {
            const { userId, answer } = JSON.parse(data);
            if (peers[userId]) {
                peers[userId].signal(answer);
            }
        });

        socket.on('user-disconnected', (userId) => {
            console.log(`Utilisateur déconnecté : ${userId}`);
            if (peers[userId]) {
                peers[userId].destroy();
                delete peers[userId];
            }
            $(`#video-${userId}`).remove(); // Supprimer la vidéo de l'utilisateur déconnecté
        });

        function createPeer(initiator, stream, userId) {
            const peer = new SimplePeer({
                initiator,
                trickle: false,
                stream
            });

            peer.on('error', (err) => console.error('Erreur Peer:', err));

            peer.on('signal', (data) => {
                if (initiator) {
                    socket.emit('offer', JSON.stringify({ userId, offer: data }));
                } else {
                    socket.emit('answer', JSON.stringify({ userId, answer: data }));
                }
            });

            peer.on('stream', (remoteStream) => {
                displayRemoteStream(remoteStream, userId);
            });

            return peer;
        }

        function acceptCall(userId, offer) {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then((stream) => {
                    if (!peers[userId]) {
                        peers[userId] = createPeer(false, stream, userId);
                    }
                    peers[userId].signal(offer);
                    displayLocalStream(stream);
                })
                .catch((err) => {
                    console.error('Erreur accès caméra/micro:', err);
                });
        }
    
        function displayLocalStream(stream) {
            const localVideo = document.querySelector('#myVideo');
            localVideo.srcObject = stream;
            $("#myVideo").fadeIn();
            $("#waitingResponse").fadeIn();
        }

        function displayRemoteStream(stream, userId) {
            i++;
            const videoContainer = document.createElement('div');
            videoContainer.id = `video-${userId}`;
            videoContainer.className = 'hidden';

            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.className = 'w-full object-contain';

            videoContainer.appendChild(video);
            // document.getElementById("videocontainerFixed").appendChild(videoContainer); // Ajouter la vidéo au DOM
            $("#videocontainerFixed").prepend(videoContainer)
            $("#videocontainerFixed").prepend(`<div class="border rounded-lg w-52 p-5 bg-white text-center text-neutral-600">
                    <p>Camera ${i}: ${userId}</p>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                        class="w-10 h-10 m-auto">
                        <path fill-rule="evenodd"
                            d="M1.371 8.143c5.858-5.857 15.356-5.857 21.213 0a.75.75 0 010 1.061l-.53.53a.75.75 0 01-1.06 0c-4.98-4.979-13.053-4.979-18.032 0a.75.75 0 01-1.06 0l-.53-.53a.75.75 0 010-1.06zm3.182 3.182c4.1-4.1 10.749-4.1 14.85 0a.75.75 0 010 1.061l-.53.53a.75.75 0 01-1.062 0 8.25 8.25 0 00-11.667 0 .75.75 0 01-1.06 0l-.53-.53a.75.75 0 010-1.06zm3.204 3.182a6 6 0 018.486 0 .75.75 0 010 1.061l-.53.53a.75.75 0 01-1.061 0 3.75 3.75 0 00-5.304 0 .75.75 0 01-1.06 0l-.53-.53a.75.75 0 010-1.06zm3.182 3.182a1.5 1.5 0 012.122 0 .75.75 0 010 1.061l-.53.53a.75.75 0 01-1.061 0l-.53-.53a.75.75 0 010-1.06z"
                            clip-rule="evenodd" />
                    </svg>
                </div>`)
        }
    </script>
</body>

</html>